G.Layer.TiledTemporal=G.Layer.TiledService.extend({mixins:[],options:{dataCubeTileSize:256,dataCubeResolution:4,radiusUnit:"pixel",colorBuckets:[{value:1,color:"#5CA2D1"},{value:0,color:"#F84F40"}],markerSizeBuckets:[{value:2,markerSize:7},{value:1,markerSize:5},{value:0,markerSize:3},{value:3,markerSize:9}],rendererType:"circle",maxOpacity:1,minOpacity:0,frameCount:0,frameDuration:200,expand:0,frameAnimStepCount:3,blendingMode:"source-over"},init:function(e,t,a){var i=this;i.url=e,i._timeFunc=t,i.options=G.Util.merge({},i.options,a),i._tiles={},i._isKeyStep=!1,i._playing=!1,i._time=null,i._step=-1,i.options.expand=i.options.expand&&i.options.expand>0?i.options.expand>6?6:i.options.expand:0,i._colorBuckets=i.options.colorBuckets,0===i._colorBuckets.length&&(i._colorBuckets[0]={value:0,color:"#F84F40"}),i._markerSizeBuckets=i.options.markerSizeBuckets,0===i._markerSizeBuckets.length&&(i._markerSizeBuckets[0]={value:0,markerSize:3}),i._markerSizeBuckets.length>0&&i._markerSizeBuckets.sort(i.sortSizeBuckets),i._tileOffset=i._markerSizeBuckets[0].markerSize+i.options.expand;var r=function(e,t,a){var r=i._getTileName(e,t,a),n=i._getTileUrl(e,t,a),o=[e,t,a];G.Util.ajax(n,{responseType:"JSONP",success:function(e,t){if(i.onSuccess(o,t),t.data){var a={};a.renderData=t.data,a.tileInfo=o,a.tileCache=[],a.animCache=[],i._tiles[r]=a}},error:function(e){i.onError(o)},complete:function(e){i.onComplete(o)}})};G.Layer.TiledService.prototype.init.call(i,r,i.options)},sortSizeBuckets:function(e,t){return t.markerSize-e.markerSize},start:function(){var e=this;if("map"===e.options.radiusUnit){var t=e._map;e._tileOffset/=t._res}return!e._playing&&e.options.frameCount>-1&&(e._startAnim(),e._playing=!0),e},stop:function(){var e=this;return G.Util.cancelAnimFrame(e._requestId),e._playing=!1,e._step=-1,e},pause:function(){var e=this;return e._playing&&(G.Util.cancelAnimFrame(e._requestId),e._playing=!1,e._isKeyStep=!0),e},setStep:function(e){var t=this,a=t._map,i=t.options;return t._playing||e>-1&&e<i.frameCount&&(t._step=e,t._isKeyStep=!0,a._requestRedraw()),t},_startAnim:function(){var e=this,t=e._map,a=e.options;!function i(r){try{if(!r)return void(e._requestId=G.Util.requestAnimFrame(i));null===e._time&&(e._time=r),e._diff=(r-e._time)/a.frameDuration,e._diff>1?(e._isKeyStep=!0,e._step++,e._step>a.frameCount+a.frameAnimStepCount-1&&(e._step=0),t._requestRedraw(),e._timeFunc(e._step),e._time=r):(e._isKeyStep=!1,e._diff>=.5&&e._step<a.frameCount&&e._preDraw()),e._requestId=G.Util.requestAnimFrame(i)}catch(n){console.error(n)}}()},_draw:function(){var e=this,t=e._tiles,a=e._ctx,i=e._step,r=e._map,n=e.options;if(!(r.isZooming()||r.isPinching()||r.isRotating()||r.isPanning())){if(e._isKeyStep){var o=a.canvas,s=o.width,l=o.height;a.clearRect(0,0,s,l);for(var c in t){var _=t[c],u=_.tileInfo;_.tileCache[i]||e._renderTile(_,i);var p=_.tileCache[i];p!==-1&&e._placeTile(p.canvas,u[0],u[1],u[2]);for(var m=n.frameAnimStepCount,d=1;d<=m;d++){var f=i-d,v=null,h=.6*(m+1-d)/(m+1),S=h*(n.maxOpacity-n.minOpacity)+n.minOpacity;f>=0&&S>=0&&(n.expand>0?(_.animCache[f]||e._renderTile(_,f,!0),v=_.animCache[f]):(_.tileCache[f]||e._renderTile(_,f),v=_.tileCache[f]),v!==-1&&(a.save(),a.globalAlpha=S,e._placeTile(v.canvas,u[0],u[1],u[2]),a.restore()))}var g=i-m-1;g>=0&&(_.tileCache[g]=null,n.expand>0&&(_.animCache[g]=null))}}if(!e._hidden){var k=r._useOffScreen?r._offScreenCtx:r._onScreenCtx,C=k.canvas;k.drawImage(a.canvas,0,0,C.width,C.height)}}},_preDraw:function(){var e=this,t=e._tiles,a=e._step,i=e.options;if(e._playing&&!e._isKeyStep){a+=1;for(var r in t){var n=t[r];n.tileCache[a]||e._renderTile(n,a),i.expand>0&&(n.animCache[a]||e._renderTile(n,a,!0))}}},_renderTile:function(e,t,a){for(var i=this,r=i.options,n=e.renderData,o=r.dataCubeResolution,s=r.expand,l=[],c=0;c<n.length;c++){var _=n[c];values=_.vals__uint8,dates=_.dates__uint16;for(var u=0;u<dates.length;u++)if(dates[u]===t){l.push({x:_.x__uint8,y:_.y__uint8,value:values[u]});break}}if(0===l.length)return e.tileCache[t]=-1,void(a&&(e.animCache[t]=-1));for(var p=[],m=i._colorBuckets.length,d=0;d<m;d++)p[d]=[];for(var c=l.length-1;c>=0;c--)for(var f=l[c].value,d=0;d<m;d++){var v=i._colorBuckets[d].value;if(f>=v){p[d].push(l[c]);break}}var h=G.DomUtil.create("canvas").getContext("2d"),S=h.canvas,g=S.width=S.height=r.dataCubeTileSize+2*i._tileOffset;h.clearRect(0,0,g,g),h.globalAlpha=r.maxOpacity,h.globalCompositeOperation=r.blendingMode;for(var d=0;d<m;d++){var k=i._colorBuckets[d].color;h.fillStyle=k,h.beginPath();for(var C=p[d],x=0;x<C.length;x++){for(var y=C[x].x,z=C[x].y,f=C[x].value,T=o/2+y*o+i._tileOffset,B=-o/2+(r.dataCubeTileSize/o-z)*o+i._tileOffset,R=0,w=0;w<i._markerSizeBuckets.length;w++){var v=i._markerSizeBuckets[w].value,O=i._markerSizeBuckets[w].markerSize;if("map"===r.radiusUnit){var b=i._map;O/=b._res}if(f>=v){R=O;break}}0!==R&&(a&&(R+=s),"rectangle"===r.rendererType?h.rect(T-R,B-R,2*R,2*R):h.arc(T,B,R,0,2*Math.PI),h.closePath())}h.fill()}a?e.animCache[t]=h:e.tileCache[t]=h},_placeTile:function(e,t,a,i){var r=this,n=G.MathUtil,o=G.Browser.getPxRatio(),s=o[0],l=o[1],c=r.options,_=r._map,u=_._rotate,p=_.options,m=_._res,d=c.zoomReses[i],f=c.dataCubeTileSize,v=f*d,h=Math.ceil((f+2*r._tileOffset)*d/m),S=c.originX+t*v,g=c.originY-a*v,k=0,C=0,x=p.maxExtent,y=x[2]-x[0];if(p.wrap){var z=r._redrawExtent;z&&x&&(C=Math.floor((z[0]-c.minX)/y)-1,k=Math.ceil((z[2]-c.maxX)/y)+1)}for(var T=Math.round,B=C;B<=k;B++){var R=S+B*y,w=g,O=_._canvasOffset,b=_.toScreen([R,w]),A=b[0]+O[0]-r._tileOffset,U=b[1]+O[1]-r._tileOffset,A=T(A);U=T(U);var D=r._ctx;D.globalCompositeOperation=c.blendingMode,u&&(D.save(),D.translate(A,U),D.rotate(u/n.DEGREE_PER_RADIAN),D.translate(-A,-U));try{D.drawImage(e,A,U,T(h/s),T(h/l))}catch(q){}u&&D.restore()}},onLoadTileSuccess:function(e){var t=this,a=t._map;a&&a._requestRedraw()},_onUpdated:function(e){var t=this,a=t._map,i=t.options,r=t._calcNearestZoom(!0),n=a.getCenter(),o=a.getDrawSize(),s=i.zoomReses[r],l=1+2*a.options.canvasExpandFactor,c=o[0]*l,_=o[1]*l,u=n[0]-c*s/2,p=n[0]+c*s/2,m=n[1]-_*s/2,d=n[1]+_*s/2;t._redrawExtent=[u,m,p,d]},_onAllLoaded:function(){var e=this,t=e._map;e.options;!e._playing&&e._isKeyStep&&t._requestRedraw()},_onAdded:function(){var e=this,t=e._map;e._initContainer(),t._requestUpdate(),e.addListener("unusedTile",e._onUnusedTile,e),e.addListener("allLoaded",e._onAllLoaded,e)},_onRemoved:function(){var e=this,t=e._map;t.removeListener("resize",e._onReize,e)},_onUnusedTile:function(e){var t=this,a=e.tileInfo,i=t._getTileName(a[0],a[1],a[2]);delete t._tiles[i]},_initContainer:function(){var e=this,t=e._map,a=G.DomUtil;e._ctx||(e._ctx=a.create("canvas").getContext("2d")),t.addListener("resize",e._onResize,e),e._onResize()},_onResize:function(){var e=this,t=e._map,a=t._useOffScreen?t._offScreenCtx:t._onScreenCtx,i=a.canvas,r=e._ctx,n=r.canvas,o=G.Browser.getCanvasRatio(),s=o?o[0]||1:1,l=o?o[1]||1:1;r.scale(s,l),n.width=i.width,n.height=i.height}});